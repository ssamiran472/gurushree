{% extends 'admin_layout.html' %} {% block content %}
<style>
</style>
<div class="card">
    <div class="card-header bg-info text-white mt-3 mb-0">
        <div class="row">
            <div class="col-md-2">
                MRD No. : {{patient.mrd_no}}
            </div>
            <div class="col-md-2">
                Name : {{patient.p_name}}
            </div>
            <div class="col-md-2">
                Age : {{patient.year}}/{{patient.gender}}
            </div>
            <div class="col-md-3">
                Regd Date/Time : {{patient.Addeddate}}
            </div>
            <div class="col-md-1">
                Total Bills : 0
            </div>
            <div class="col-md-1">
                Total Dues : 6
            </div>
        </div>
    </div>
    <div class="card-body h-100 pl-0 pr-0" >
        <div class="row">
            <div class="form-group col-md-3">
                <select class="btn btn-info form-control" id="ConsultantList">
                </select>
            </div>
            <div class="form-group col-md-3">
                <input type="text" id="services" class="form-control" placeholder="Enter Service type">
            </div>
            <div class="form-group col-md-2">
                <!-- <button type="button" class="btn btn-secondary btn-block"></button> -->
                <a class="nav-link collapsed btn btn-secondary btn-block" href="#" data-toggle="collapse"
                    data-target="#formOfDiscountee" aria-expanded="false" aria-controls="collapseTwo">

                    <span>Discount</span>
                </a>
            </div>
            <div class="form-group col-md-2">
                <!-- <button type="button" class="btn btn-secondary btn-block">Patient History</button> -->
                <a class="nav-link collapsed btn btn-secondary btn-block" href="#" data-toggle="collapse"
                    data-target="#patient_history" aria-expanded="false" aria-controls="collapseTwo">

                    <span>Patient History</span>
                </a>
            </div>
            <div class="form-group col-md-2">
                <select required id="registration__type" class="btn btn-info form-control">
                    <option value="">-Registration Type-</option>
                </select>
            </div>
        </div>
        <div id="formOfDiscountee" class="collapse active col-12 p-3">
            <form>
                <div class="row">
                    <div class="form-froup col-md-6">
                        <select class="form-control">
                            <option>Select Discountee</option>
                            <option>admin</option>
                            <option>patient</option>
                            <option>doctor</option>
                        </select>
                    </div>
                    <div class="form-froup col-md-6">
                        <select class="form-control">
                            <option>Select Discountee</option>
                            <option>admin</option>
                            <option>patient</option>
                            <option>doctor</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label for="textarea">Refferal Notes</label>
                        <textarea class="form-control" placeholder="Write somethig" id="textarea" rows='5'
                            cols='50'></textarea>
    
                    </div>
                    <div class="row col-md-6 ml-1 mt-2">
                        <input type="password" class="form-control" placeholder="Enter password">
                    </div>
                </div>
                <div class="row m-2">
                    <button class="btn btn-active btn-secondary" type="submit">Authorise</button>
                    <button class="btn btn-active btn-secondary ml-2" type="button">Reset</button>
                </div>
            </form>
        </div>

        <div id="patient_history" class="collapse active col-12">
            <table id="" class="table table-striped table-bordered table-hover p-0">
                <thead class="bg-info text-white">
                    <tr>
                        <th>SL No.</th>
                        <th style="width: 200px;">Bill No.</th>
                        <th style="width: 192px;">Bill Date</th>
                        <th>Service Name</th>
                        <th>Total Amount</th>
                        <th>Discount</th>
                        <th style="width: 220px;">
                            Net Amount
                        <th>User name</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="table-responsive">
            <table id="billDetails" class="table  table-bordered table-hover p-0">
                <thead class="bg-info text-white">
                    <tr>
                        <th scope="col" ></th>
                        <th scope="col" style="width: 200px;">Service</th>
                        <th scope="col" style="width: 192px;">Sub Service</th>
                        <th scope="col">Qty</th>
                        <th scope="col">Ser_Amt</th>
                        <th scope="col">Tot_amt</th>
                        <th scope="col" style="width: 220px;">
                            <select class="btn btn-info btn-sm tableHeadConultant">
                            </select> <input type="checkbox"></th>
                        <th scope="col"> Dr_share</th>
                        <th scope="col">Dr_Disc</th>
                        <th scope="col" style="width: 220px;">
                            <select class="btn btn-info btn-sm tableHeadRefferals">
                                <option value="">-Select Refferal-</option>
                                {% for consultant in Refferals %}
                                <option value="{{consultant.professionalName}}">{{consultant.professionalName}}</option>
                                {% endfor %}
                            </select> <input type="checkbox"></th>
                        <th scope="col">Ref_share</th>
                        <th scope="col">Ref_disc</th>
                        <th scope="col">Tot_amt</th>
                        <th scope="col">Hosp_disc</th>
                        <th scope="col">Net_amt</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <div class="card-footer">
        <div class="summary fixed-bottom-fluid">
            <table class="table table-striped table-hover">
                <thead class="bg-info text-white">
                    <tr>
                        <th colspan="2">Summary</th>
                        <th colspan="2">Discount</th>
                        <th colspan="2">Mode of Payment</th>
                        <th colspan="2">Cash Status</th>
                        <th colspan="2">Insurance Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th>Ins Cover</th>
                        <td class="summarys">0</td>
                        <th>Consulting Dr.</th>
                        <td>0</td>
                        <th>To be Paid</th>
                        <td class="netamountVal">00</td>
                        <th>Paid</th>
                        <td id="paidAmounts" class="netamountVal">00</td>
                        <th>Paid</th>
                        <td>0</td>
                    </tr>
                    <tr>
                        <th>Discount N/A</th>
                        <td class="summarys">0</td>
                        <th>Refferal Dr.</th>
                        <td>0</td>
                        <th>Cash</th>
                        <td><input type="text" id="cashPayment" value="00"></td>
                        <th>Balance</th>
                        <td id="balance">00</td>
                        <th>Balance</th>
                        <td>0</td>
                    </tr>
                    <tr>
                        <th>Discount App</th>
                        <td class="netamountVal summarys">0</td>
                        <th>Hospital</th>
                        <td>0</td>
                        <th>Card</th>
                        <td>0</td>
                        <th>Refund</th>
                        <td>0</td>
                        <th>Discount</th>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td class="text-lg text-dark"><b>Total Amount</b></td>
                        <td id="totalAmount">00</td>
                        <td class="text-lg text-dark"><b>Net Discount @ 0%</b></td>
                        <td>0</td>
                        <th>Others</th>
                        <td>0</td>
                        <td>
                            <button type="button" id="saveBill" class="btn btn-lg btn-info btn-block">
                                <i class="fa fa-save"></i> Save Bill
                            </button>
                        </td>
                        <td>
                            <button type="button" class="btn sr-only btn-lg btn-primary btn-block">
                                <i class="fa fa-eye-slash"></i> Hide Summary
                            </button>

                        </td>
                        <td>
                            <button type="button" class="btn btn-lg btn-info btn-block">
                                <i class="fa fa-database"></i> Hold Bill
                            </button>
                        </td>
                        <td class="bg-dark text-center text-white">
                            <h4 class="mt-3">PAY: INR <span id="total_payable_amount">00.00</span></h4>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

</div>

{% endblock %}
<!-- Scripts -->
{% block scripts %}
<script>
    function loadRefferals(selector) {
        $.getJSON('/api/masters/professional?isActive=True&category=R', {}, function (data) {
            var options = '<option value="">-Select Refferal-</option>'
            $.each(data, function (i, item) {
                options += `<option value='${JSON.stringify(data)}'>${data.professionalName}</option>`
            })
            $(selector).html(options)
        })
    }

    $(document).ready(function () {
        var billData = {
            billDetails: []
        };
        var billHistory = []

        //$.getJSON('/api/masters/professional?isActive=True&category=C', {}, function (data) {
        //    if(data){
        //        billHistory=data;
        //    }
        //})

        $('#sidebarToggle').trigger('click');

        $.getJSON('/api/masters/professional?isActive=True&category=C', {}, function (data) {
            var options = '<option value="">-Select Consultant-</option>'
            $.each(data, function (i, item) {
                options += `<option value='${JSON.stringify(item)}'>${item.professionalName}</option>`
            })
            $('#ConsultantList').html(options)
            $('#billDetails .tableHeadConultant').html(options)
        })

        map = {}
        
        $.getJSON('/api/masters/service/?isActive=True', {}, function (data) {
            if (data) {
                var departments = []

                $.each(data, function (i, item) {
                    map[item.ServiceName] = item
                    departments.push(item.ServiceName)
                })
                $("#services").autocomplete({
                    source: departments,
                    minLength: 1,
                    select: function (event, ui) {
                        this.value = '';
                        addService(ui.item.value)
                        return false;
                    }
                })
            }
        })



        loadRefferals('#billDetails .tableHeadRefferals')

        function checkConsultation(name) {
            return true;
        }


        $('#ConsultantList').change(function () {
            addConsultant()
        })

        let total_net_amount = 0;

        function addConsultant() {
            var consData = $('#ConsultantList').val() == '' ?
                null : JSON.parse($('#ConsultantList').val());
            var contains = billData.billDetails.some(function (elem) {
                return consData.professionalName === elem.professionalName;
            });
            if (!contains && consData) {
                billData.billDetails.push(consData);
                var table = document.getElementById('billDetails').getElementsByTagName('tbody')[0]
                var row = table.insertRow(table.rows.length)
                var cells = []
                for (var i = 0; i < 16; i++) {
                    cells[i] = row.insertCell(i)
                }
                cells[0].innerHTML = table.rows.length
                cells[1].innerHTML = consData.title + ' ' + consData.professionalName
                cells[2].innerHTML = ""
                cells[3].innerHTML = "<input type='text' class='form-control form-control-sm' value='1'  disabled='disabled'>"
                cells[4].innerHTML = `<input type='text' class='form-control form-control-sm' value=
                                 '${billHistory.length == 0 ? consData.OPNewVisit :
                        checkConsultation(consData.professionalName) ? consData.OPRevisit :
                            consData.OPFollowup}'>`
                cells[5].innerHTML = `<input type='text' class='form-control form-control-sm' value=
                                 '${billHistory.length == 0 ? consData.OPNewVisit :
                        checkConsultation(consData.professionalName) ? consData.OPRevisit :
                            consData.OPFollowup}'>`
                cells[6].innerHTML = `<select class="form-control btn-sm text-info text-bold tableConsultant" disabled="disabled" >
                                  ${$('#ConsultantList').html()}
                                  </select>`
                cells[7].innerHTML = "<input type='text' class='form-control form-control-sm' value='0'>"
                cells[8].innerHTML = "<input type='text' class='form-control form-control-sm' value='0'>"
                cells[9].innerHTML = `<select class="form-control btn-sm tableRefferals">
                                  ${$('#billDetails .tableHeadRefferals').html()}
                                  </select>`
                cells[10].innerHTML = "<input type='text' class='form-control form-control-sm' value='0'>"
                cells[11].innerHTML = "<input type='text' class='form-control form-control-sm' value='0'>"
                cells[12].innerHTML = `<input type='text' class='form-control form-control-sm' value=
                                 '${billHistory.length == 0 ? consData.OPNewVisit :
                        checkConsultation(consData.professionalName) ? consData.OPRevisit :
                            consData.OPFollowup}'>`
                cells[13].innerHTML = "<input type='text' class='form-control form-control-sm' value='0'>"
                cells[14].innerHTML = `<input type='text' class='form-control form-control-sm' value=
                                 '${billHistory.length == 0 ? consData.OPNewVisit :
                        checkConsultation(consData.professionalName) ? consData.OPRevisit :
                            consData.OPFollowup}'>`
                cells[15].innerHTML = "<button type='button' class='btn btn-circle btn-danger'><i class='fa fa-trash'></i></button>"

                // update down tables..(summary , discount etc)
                total_net_amount += parseFloat(jQuery(cells[14]).children().first().val())
                updateTables()

                $('#billDetails .tableConsultant:last-child').val($('#ConsultantList').val())
                $('#ConsultantList').val('')
            }
        }



        function addService(serName) {
            var serData = map[serName]
            total_net_amount += serData.SerAmount;
            var table = document.getElementById('billDetails').getElementsByTagName('tbody')[0]
            var row = table.insertRow(table.rows.length)
            var cells = []
            for (var i = 0; i < 16; i++) {
                cells[i] = row.insertCell(i)
            }
            cells[0].innerHTML = table.rows.length
            cells[1].innerHTML = serData.ServiceName
            cells[2].innerHTML = ""
            cells[3].innerHTML = "<input type='text' class='form-control form-control-sm' value='1'>"
            cells[4].innerHTML = `<input type='text' class='form-control form-control-sm' value=
                                 '${serData.SerAmount}'>`
            cells[5].innerHTML = `<input type='text' class='form-control form-control-sm' value=
                                 '${serData.SerAmount}'>`
            cells[6].innerHTML = `<select class="form-control btn-sm tableConsultant" ${serData.OP} >
                                  ${$('#ConsultantList').html()}
                                  </select>`
            cells[7].innerHTML = "<input type='text' class='form-control form-control-sm' value='0'>"
            cells[8].innerHTML = "<input type='text' class='form-control form-control-sm' value='0'>"
            cells[9].innerHTML = `<select class="form-control btn-sm tableRefferals">
                                  ${$('#billDetails .tableHeadRefferals').html()}
                                  </select>`
            cells[10].innerHTML = "<input type='text' class='form-control form-control-sm' value='0'>"
            cells[11].innerHTML = "<input type='text' class='form-control form-control-sm' value='0'>"
            cells[12].innerHTML = `<input type='text'  class='total_amount form-control form-control-sm' value=
                                 '${serData.SerAmount}'>`
            cells[13].innerHTML = "<input type='text' class='form-control form-control-sm' value='0'>"
            cells[14].innerHTML = `<input type='text' class='netamount form-control form-control-sm' value=
                                 '${serData.SerAmount}'>`
            cells[15].innerHTML = "<button type='button' class='btn btn-circle btn-info'><i class='fa fa-trash'></i></button>"

            // update down tables..(summary , discount etc)
            updateTables()

        }

        function displaySummary() {

        }
        //update down tables..(summary , discount etc)
        function updateTables(){
            let netamounts = $('.netamountVal');
            $('#cashPayment').val(total_net_amount)
            for (let i = 0; i < netamounts.length; i++) {
                $(netamounts).html(total_net_amount)
            }
            let summarys = $('.summarys');
            let total = 0;
            for (let i = 0; i < summarys.length; i++) {
                const amounts = parseFloat($(summarys[i]).html())
                total += amounts;
            }
            $('#totalAmount').html(total)
            $('#total_payable_amount').html(total_net_amount)
        }
    
        ////////// REGISTRATION TYPE ////////// 
    function registration_type(){
        $.get('/api/masters/registrationType')
        .done(resp=>{
            resp.map(registrationType=>{
                $('#registration__type').append(`<option value="${registrationType.id}">${registrationType.regType}</option>`)
            })
        })
        .fail(err=>{
            console.log(err)
        })
    }

    registration_type()


    //////////  Saving  Bill ////////// 

    function save_bill(){
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const patient_id = urlParams.get('patient_id')
        let data = {
            RegNo: patient_id,
            RegType: $('#registration__type').val(),
            PayType: 'self',
            DiscType: 'admin',
            TotalAmount: $('#totalAmount').text(),
            NetAmount: $('#totalAmount').text(),
            Payable: $('#paidAmounts').text(),
            Balance: $('#balance').text(),
            PaidAmount: $('#paidAmounts').text(),
        }
        $.ajax({
            url: '/api/trans/billheader/',
            method: 'POST',
            data:  JSON.stringify(data),
            contentType: 'application/json'
        })
        .done(res=>{
            console.log(res)
        })
        .fail(err=>{
            console.log(err)
        })
    }


    $('#saveBill').click(function(){
        save_bill()
    })

    function handleCashPayments () {
        const cashAmounts = $('#cashPayment').val()
        let balance = total_net_amount-cashAmounts;
        $('#balance').text(balance);
        $('#paidAmounts').text(cashAmounts);

    }
    $('#cashPayment').bind("keypress mousedown change",handleCashPayments) ;
    
    
    })   


    

</script>
{% endblock %}